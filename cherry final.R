#Title: Cherry Blossom Prediction Project
#Name: Marilyn Davidson 
#Date: 02/27/2023

### initializing
library("knitr")
library("tidyverse")
library('lubridate')
install.packages("rnpn")
library("rnoaa")
library("rnpn")
library(readr)
theme_set(theme_bw(base_size = 20))

### extracting historic temp data
get_temperature <- function (stationid) {
  ghcnd_search(stationid = stationid, var = c("TAVG","tmax"), 
               date_min = "1950-01-01", date_max = "2022-01-31",refresh = TRUE)[[1]]
}

historic_temperatures <-
  tibble(location = "washingtondc", get_temperature("USC00186350")) %>%
  bind_rows(tibble(location = "liestal", get_temperature("GME00127786"))) %>%
  bind_rows(tibble(location = "kyoto", get_temperature("JA000047759"))) %>%
  bind_rows(tibble(location = "vancouver", get_temperature("CA001108395")))  

### cleaning data frames 
# kyoto
# note that the process for cleaning the data is the same for each location 
kyoto <- read_csv("kyoto.csv")
kyoto2 <- filter(historic_temperatures, location== "kyoto")
# creating a column with the start date of every year in order to make a 
# loop that isolates the temperatures between the start of the year and 
# the bloom date
kyotodate<-c(seq(ymd('1953-01-01'),ymd('2022-01-01'), by= '1 year'))
# get rid of bloom dates that come before the historic temps begin
kyoto<-subset(kyoto, bloom_date >= '1953-01-01')
kyoto$year<-kyotodate
# create empty data frames and lists for info generated by the loop
kyotofin<-data.frame()
kavgsum<-c()

# subset info that falls within the start of the year and the bloom date 
# and create a list of sums where each value is the sum of temperatures 
# within the subset
for (i in 1:nrow(kyoto)) {
  ky <- subset(kyoto2, date >= kyoto$year[i] & date <= kyoto$bloom_date[i])
  kavgsum<- append(kavgsum,sum(ky$tavg), after = length(kavgsum))
  kyotofin<- rbind(kyotofin,ky)
}

#dc

washingtondc <- read_csv("washingtondc.csv")
dc<-filter(historic_temperatures, location == "washingtondc")
dcdate<- c(seq(ymd('1950-01-01'), ymd('2022-01-01'), by = '1 year'))
washingtondc<-subset(washingtondc, bloom_date >= '1950-01-01')
washingtondc$year<- dcdate
dcfin<-data.frame()
# note that kyoto only had the average temperature for each day whereas
# the DC and liestal info had the max temperature for each day
# so this step differs from the kyoto data cleaning
dcmaxsum<-c()

for (i in 1:nrow(washingtondc)) {
  dc1 <- subset(dc, date >= washingtondc$year[i] & date <= washingtondc$bloom_date[i])
  dcmaxsum<- append(dcmaxsum,sum(dc1$tmax), after = length(dcmaxsum))
  dcfin<- rbind(dcfin,dc1)
}

#liestal

liestal <- read_csv("liestal.csv")
ls<- filter(historic_temperatures, location =='liestal')
lsdate<-c(seq(ymd('1953-01-01'),ymd('2022-01-01'), by= '1 year'))
liestal<-subset(liestal, bloom_date >= '1953-01-01')
liestal$year <- lsdate
lsfin<-data.frame()
lsmaxsum<-c()

for (i in 1:nrow(liestal)) {
  ls1 <- subset(ls, date >= liestal$year[i] & date <= liestal$bloom_date[i])
  lsmaxsum<- append(lsmaxsum,sum(ls1$tmax), after = length(lsmaxsum))
  lsfin<- rbind(lsfin,ls1)
}

######making models
#kyoto

kyotodate2<-c(1:length(kavgsum))
ky2<-data.frame(kyotodate2,kavgsum,kyoto$bloom_doy)
ky2<-filter(ky2, kavgsum>0)
kymodel<-loess(kyoto.bloom_doy~kyotodate2+kavgsum, data=ky2)
kymodelsum<-loess(kavgsum~kyotodate2, data = ky2)
futuresum<-predict(kymodelsum, kyotodate2 = seq(70,80,1))
future<-data.frame(kyotodate2 = seq(71,80,1), kavgsum=futuresum[1:10])
japan<-predict(kymodel,kyotodate2 = future$kyotodate2, kavgsum = future$kavgsum)
japan<-round(japan)

#dc 

dcdate2<-c(1:length(dcmaxsum))
dc2<-data.frame(dcdate2,dcmaxsum,washingtondc$bloom_doy)
dc2<-filter(dc2, dcmaxsum>0)
dcmodel<- loess(washingtondc.bloom_doy ~ dcdate2+dcmaxsum, data = dc2)
dcmodelsum<-loess(dcmaxsum~dcdate2, data = dc2)
futuresumdc<-predict(dcmodelsum,dcdate2= seq(length(dcmaxsum),length(dcmaxsum)+10,1))
futuredc<-data.frame(dcdate2 = seq(length(dcmaxsum),length(dcmaxsum)+10,1), 
                   dcmaxsum = futuresumdc[1:11])
USA<-predict(dcmodel, dcdate2 = futuredc$dcdate2, dcmaxsum = futuredc$dcmaxsum)
USA<-round(USA)

#liestal

lsdate2<-c(1:length(lsmaxsum))
ls2<-data.frame(lsdate2,lsmaxsum,liestal$bloom_doy)
ls2<-filter(ls2,lsmaxsum>0)
lsmodel<- loess(liestal.bloom_doy~ lsdate2+lsmaxsum, data = ls2)
lsmodelsum<- loess(lsmaxsum~lsdate2, data = ls2)
futuresumls<-predict(lsmodelsum,lsdate2 = seq(length(lsmaxsum),length(lsmaxsum)+10,1))
futurels<-data.frame(lsdate2 = seq(length(lsmaxsum),length(lsmaxsum)+10,1), 
                     lsmaxsum = futuresumls[1:11])
swiss<-predict(lsmodel,lsdate2 = futurels$lsdate2, dcmaxsum = futurels$lsmaxsum)
swiss<-round(swiss)

# using the DC model for Vancouver predictions because the longitude and latitude
# are most similar to one another

Vancouver <- predict(dcmodel, dcdate2 = futuredc$dcdate2, dcmaxsum = futuredc$dcmaxsum)
Vancouver <- round(Vancouver)

#Final steps

year<-c(2023:2032)
final<- data.frame(year,japan[1:10],swiss[1:10],USA[1:10],Vancouver[1:10])
write.table(final,'C:\Users\mdavi\Desktop\school\spring 2023\STAT 490',sep = ",",rownames=FALSE)

